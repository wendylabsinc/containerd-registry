name: Build Container Image

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For creating releases
      packages: write  # For pushing to GHCR

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Build and push to registry
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Install crane for image export
      - name: Install crane
        run: |
          curl -sLo /tmp/crane.tar.gz "https://github.com/google/go-containerregistry/releases/download/v0.19.1/go-containerregistry_Linux_x86_64.tar.gz"
          echo "5f2b43c32a901adaaabaa78755d56cea71183954de7547cb4c4bc64b9ac6b2ff  /tmp/crane.tar.gz" | sha256sum -c -
          tar -xz -C /tmp -f /tmp/crane.tar.gz
          sudo mv /tmp/crane /usr/local/bin/
          crane version

      # Export platform images as tars for Yocto builds and .deb/.rpm packages
      - name: Export platform images
        run: |
          # Extract the first tag from metadata
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | grep -m1 "ghcr.io")

          # Authenticate crane to ghcr.io
          echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u ${{ github.actor }} --password-stdin

          # Export ARM64 and AMD64 images as Docker tars
          for arch in arm64 amd64; do
            crane pull --platform "linux/${arch}" "${IMAGE_TAG}" "containerd-registry-${arch}.tar"
            gzip "containerd-registry-${arch}.tar"
          done

      - name: Generate checksums
        run: |
          sha256sum containerd-registry-arm64.tar.gz > containerd-registry-arm64.tar.gz.sha256
          sha256sum containerd-registry-amd64.tar.gz > containerd-registry-amd64.tar.gz.sha256

      # Upload to GitHub Release (permanent, for Yocto builds)
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          files: |
            containerd-registry-arm64.tar.gz
            containerd-registry-arm64.tar.gz.sha256
            containerd-registry-amd64.tar.gz
            containerd-registry-amd64.tar.gz.sha256
          body: |
            ## Container Registry Release ${{ github.ref_name }}

            ### For Yocto Builds / .deb Packages
            Download the image tar for your platform:
            - **ARM64**: `containerd-registry-arm64.tar.gz` ([checksum](containerd-registry-arm64.tar.gz.sha256))
            - **AMD64**: `containerd-registry-amd64.tar.gz` ([checksum](containerd-registry-amd64.tar.gz.sha256))

            ```bitbake
            SRC_URI = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/containerd-registry-arm64.tar.gz"
            SRC_URI[sha256sum] = "..." # Copy from .sha256 file
            ```

            ### For Docker/Podman
            ```bash
            # Pull from GitHub Container Registry (multi-arch)
            docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}

            # Or load from downloaded tar
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/containerd-registry-arm64.tar.gz
            gunzip containerd-registry-arm64.tar.gz
            docker load -i containerd-registry-arm64.tar
            ```

            ### Configuration
            See [README.md](https://github.com/${{ github.repository }}) for environment variable configuration.

      # Upload as artifact for main branch (temporary, for testing)
      - name: Upload artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: containerd-registry-${{ github.sha }}
          path: |
            containerd-registry-arm64.tar.gz
            containerd-registry-arm64.tar.gz.sha256
            containerd-registry-amd64.tar.gz
            containerd-registry-amd64.tar.gz.sha256
          retention-days: 30
